â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
DOCUMENTATIONAUTOMATION AGENT - END-TO-END IMPLEMENTATION GUIDE
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

VERSION: 1.0 (Production Foundation)
GOAL: Achieve complete functional workflow from Excel change to approved document
PRIORITY: High quality, systematic implementation, no shortcuts
TIMELINE: Tonight - complete foundation agent

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
CRITICAL SUCCESS FACTORS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

1. Each step must be FULLY FUNCTIONAL before moving to next
2. Test each step individually with real data
3. Ask architect Claude for specific code/clarification when needed
4. Do NOT skip error handling - it's critical for production
5. Database operations must be transactional where appropriate
6. File operations must handle locks, permissions, paths correctly
7. Workflow events provide audit trail - implement them properly

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
FILING STRUCTURE (DATABASE-MIRRORED)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

BASE PATH: C:\Temp\Documentation-Catalog

/Documentation-Catalog/
  â”œâ”€â”€ /Drafts/                                           â† All drafts until approved
  â”‚   â”œâ”€â”€ BR-0001_DRAFT_irf_agent.docx
  â”‚   â””â”€â”€ SP-0001_DRAFT_usp_03500.docx
  â”‚
  â””â”€â”€ /Database/
      â””â”€â”€ /IRFS1/
          â”œâ”€â”€ /dbo/
          â”‚   â”œâ”€â”€ /Tables/
          â”‚   â”‚   â””â”€â”€ /{TableName}/
          â”‚   â”‚       â””â”€â”€ /Change Documentation/         â† BR/EN/DF files
          â”‚   â”‚           â”œâ”€â”€ BR-0043-irf_agent-All-BAS-9751.docx
          â”‚   â”‚           â””â”€â”€ BR-0043-irf_agent-All-BAS-9751_v1.1.docx
          â”‚   â”‚
          â”‚   â””â”€â”€ /StoredProcedures/                     â† SP docs at schema level
          â”‚       â”œâ”€â”€ SP-0001-usp_03500.docx
          â”‚       â””â”€â”€ SP-0001-usp_03500_v1.1.docx
          â”‚
          â””â”€â”€ /gwpc/
              â””â”€â”€ /StoredProcedures/
                  â””â”€â”€ SP-0015-usp_ReportDaily.docx

NAMING CONVENTIONS:
- Draft: BR-0001_DRAFT_TableName.docx
- Final v1.0: BR-0001-TableName-ColumnName-JiraNumber.docx
- Updated v1.1: BR-0001-TableName-ColumnName-JiraNumber_v1.1.docx
- SP docs: SP-0001-usp_ProcedureName.docx

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
DATABASE TABLES REFERENCE
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

PRIMARY TABLES:
1. DaQa.DocumentChanges - Source of truth for change tracking
2. DaQa.ApprovalWorkflow - Approval queue management
3. DaQa.MasterIndex - Comprehensive metadata (116 fields)
4. DaQa.WorkflowEvents - Real-time workflow tracking
5. DaQa.TeamsNotificationLog - Notification history
6. DaQa.DocumentVersionHistory - Version tracking for SP docs

KEY FIELDS IN DocumentChanges:
- DocId (initially NULL) - Generated by system
- JiraNumber - From Excel
- Status - Must be "Completed" to trigger
- TableName, ColumnName, SchemaName - Database objects affected
- ReportedBy, AssignedTo - People
- ChangeApplied - Description
- StoredProcedureName - If applicable
- DraftFilePath - Set during draft creation
- FinalFilePath - Set after approval
- CodeQualityScore, CodeQualityGrade - From audit

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
STEP 1: EXCEL TO DATABASE SYNC
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

OBJECTIVE: ExcelChangeIntegratorService monitors Excel, syncs to DocumentChanges

WHAT YOU HAVE:
Check if you have ExcelChangeIntegratorService.cs with:
- EPPlus library for Excel parsing
- Polling mechanism (every 1 minute default)
- UPSERT logic to DocumentChanges table

WHAT IT MUST DO:
1. Monitor: C:\Users\Alexander.Kirby\Desktop\Doctest\BI Analytics Change Spreadsheet.xlsx
2. Read rows where Status = "Completed"
3. For each row:
   - If DocId is NULL/empty â†’ This is a NEW change (skip for now, Step 2 handles)
   - If DocId exists â†’ UPDATE existing DocumentChanges row
4. Map Excel columns to DocumentChanges columns:
   - JiraNumber â†’ JiraNumber
   - Status â†’ Status
   - TableName â†’ TableName
   - ColumnName â†’ ColumnName
   - ReportedBy â†’ ReportedBy
   - AssignedTo â†’ AssignedTo
   - ChangeApplied â†’ ChangeApplied
   - DateRequested â†’ DateRequested
   - (Map remaining columns as needed)
5. Log: All operations to WorkflowEvents (EventType: ExcelChangeDetected)

ERROR HANDLING:
- File locked by Excel â†’ Log warning, retry next poll cycle
- Missing columns â†’ Log error, skip row, continue
- Database connection failure â†’ Retry 1 time after 2s, then alert

VERIFICATION:
Run query: SELECT * FROM DaQa.DocumentChanges WHERE Status = 'Completed' AND DocId IS NULL
You should see rows synced from Excel.

ASK ARCHITECT IF:
- ExcelChangeIntegratorService doesn't exist or is incomplete
- Unsure about column mappings
- Polling mechanism not working

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
STEP 2: DOCID GENERATION & WORKFLOW TRIGGER
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

OBJECTIVE: Watcher detects rows without DocId, generates DocId, triggers workflow

WHAT YOU NEED:
Service that polls DaQa.DocumentChanges for rows where:
- Status = 'Completed'
- DocId IS NULL

WHAT IT MUST DO:
1. Query for new changes:
   ```sql
   SELECT TOP 1 *
   FROM DaQa.DocumentChanges
   WHERE Status = 'Completed' AND DocId IS NULL
   ORDER BY DateRequested ASC
   ```

2. Generate DocId using MAX+1 logic:
   - Determine type from ChangeApplied or explicit Type column:
     * "Business Request" â†’ BR
     * "Enhancement" â†’ EN
     * "Defect" or "Bug" â†’ DF
   - Query: 
     ```sql
     SELECT MAX(CAST(SUBSTRING(DocId, 4, 10) AS INT))
     FROM DaQa.DocumentChanges
     WHERE DocId LIKE 'BR-%'  -- or EN-%, DF-%
     ```
   - Next DocId = MAX + 1, zero-padded: BR-0001, BR-0002, etc.

3. Update DocumentChanges row:
   ```sql
   UPDATE DaQa.DocumentChanges
   SET DocId = @GeneratedDocId
   WHERE [UniqueIdentifier] = @RowId
   ```

4. Publish WorkflowEvent:
   - WorkflowId: WF-{DocId} (e.g., "WF-BR-0001")
   - EventType: WatcherDetectedNewRow
   - Status: Completed
   - Message: "New change detected: {JiraNumber}, assigned DocId: {DocId}"

5. Trigger draft generation (call DocGeneratorService or queue)

ERROR HANDLING:
- No rows found â†’ Normal, continue polling
- DocId collision â†’ Retry generation (shouldn't happen with single-threaded)
- Update fails â†’ Log error, do NOT proceed to draft generation

VERIFICATION:
Check: DocumentChanges row now has DocId populated
Check: WorkflowEvents table has WatcherDetectedNewRow event

ASK ARCHITECT IF:
- Unsure how to determine document type (BR/EN/DF)
- DocId generation logic unclear
- Don't know how to trigger DocGeneratorService

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
STEP 3: CODE EXTRACTION FROM STORED PROCEDURE
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

OBJECTIVE: Extract marked code section and full SP definition for context

WHAT YOU NEED:
Method in DocGeneratorService: ExtractMarkedCodeAsync(string spName, string jiraNumber)

WHAT IT MUST DO:
1. Query sys.sql_modules for SP definition:
   ```sql
   SELECT m.definition
   FROM sys.sql_modules m
   INNER JOIN sys.objects o ON m.object_id = o.object_id
   INNER JOIN sys.schemas s ON o.schema_id = s.schema_id
   WHERE s.name + '.' + o.name = @StoredProcedureName
   ```

2. Search for marked sections using Jira number:
   - Start marker: `-- BEGIN {JiraNumber}` or `-- START {JiraNumber}`
   - End marker: `-- END {JiraNumber}`
   - Extract text between markers
   - Count lines of marked code

3. Publish WorkflowEvents:
   - CodeExtractionStarted (before query)
   - CodeExtractionCompleted (after success)
   - Include in metadata: { LineCount: X, HasMarkers: true/false }

4. Return object containing:
   - MarkedCode: The extracted section
   - FullProcedureDefinition: Entire SP code
   - LineCount: Number of lines in marked section
   - ProcedureName: Fully qualified name

ERROR HANDLING:
- SP not found in database:
  * Log warning to WorkflowEvents (EventType: CodeExtractionFailed, Status: Warning)
  * Send Teams notification: "âš ï¸ Stored procedure {spName} not found for {JiraNumber}"
  * Return NULL (allow workflow to continue without SP doc)
  * Do NOT fail entire workflow
  
- No marked sections found:
  * Log warning
  * Send Teams notification: "âš ï¸ No marked code found in {spName} for {JiraNumber}"
  * Return full SP definition anyway (for context)
  
- Database connection failure:
  * Retry 1 time after 2s
  * If still fails, log error and STOP workflow
  * Send Teams alert: "âŒ Failed to extract code for {JiraNumber}"

VERIFICATION:
Log output should show:
- Extracted code section
- Line count
- Full SP definition length

ASK ARCHITECT IF:
- Don't have ExtractMarkedCodeAsync method
- Unclear on marker format
- Unsure how to query sys.sql_modules

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
STEP 4: CODE QUALITY AUDIT
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

OBJECTIVE: Analyze code quality, assign score and grade

WHAT YOU NEED:
IEnterpriseCodeQualityAuditService (already exists - DO NOT REWRITE)

WHAT IT MUST DO:
1. Call audit service:
   ```csharp
   var auditResult = await _codeQualityService.AuditCodeQualityAsync(
       extractedCode.MarkedCode ?? extractedCode.FullProcedureDefinition,
       cancellationToken);
   ```

2. Publish WorkflowEvents:
   - CodeQualityAuditStarted
   - CodeQualityAuditCompleted
   - Metadata: { Score: 87, Grade: "B", Category: "Performance" }

3. Check grade and warn if poor:
   - If Grade = "D" or "F":
     * Set event Status = Warning (not Failed)
     * Log warning message
     * Continue workflow (do NOT block)

4. Store results in DocumentChanges:
   ```sql
   UPDATE DaQa.DocumentChanges
   SET CodeQualityScore = @Score,
       CodeQualityGrade = @Grade
   WHERE DocId = @DocId
   ```

ERROR HANDLING:
- Audit service throws exception:
  * Log error
  * Set Score = NULL, Grade = "N/A"
  * Continue workflow (audit is nice-to-have, not blocking)

VERIFICATION:
- DocumentChanges has CodeQualityScore and CodeQualityGrade populated
- WorkflowEvents shows audit events

NOTE: EnterpriseCodeQualityAuditService already exists with 100-point scoring.
DO NOT modify it. Just call it.

ASK ARCHITECT IF:
- Can't find IEnterpriseCodeQualityAuditService
- Getting errors from audit service
- Unsure what to do with audit results

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
STEP 5: DRAFT DOCUMENT GENERATION (CHANGE DOC)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

OBJECTIVE: Generate draft change documentation using correct template

WHAT YOU NEED:
- BusinessRequestTemplate.cs
- EnhancementTemplate.cs
- DefectTemplate.cs
- TemplateHelper.cs (shared formatting methods)

WHAT IT MUST DO:
1. Determine which template to use based on DocId prefix:
   - BR-XXXX â†’ BusinessRequestTemplate
   - EN-XXXX â†’ EnhancementTemplate
   - DF-XXXX â†’ DefectTemplate

2. Gather data for template:
   - From DocumentChanges: DocId, JiraNumber, Status, DateRequested, ReportedBy, AssignedTo, TableName, ColumnName, ChangeApplied
   - From code extraction: MarkedCode, FullProcedureDefinition
   - From code audit: CodeQualityScore, CodeQualityGrade
   - From AI: BusinessDefinition, TechnicalExplanation (call Azure OpenAI if configured)

3. Publish WorkflowEvent:
   - DraftDocumentGenerationStarted

4. Call appropriate template:
   ```csharp
   var doc = BusinessRequestTemplate.Generate(new TemplateData
   {
       DocId = docId,
       JiraNumber = jiraNumber,
       Status = "Draft",
       // ... all other fields
   });
   ```

5. Save to /Drafts/ folder:
   - Path: C:\Temp\Documentation-Catalog\Drafts\{DocId}_DRAFT_{TableName}.docx
   - Example: BR-0001_DRAFT_irf_agent.docx

6. Update DocumentChanges:
   ```sql
   UPDATE DaQa.DocumentChanges
   SET DraftFilePath = @DraftPath
   WHERE DocId = @DocId
   ```

7. Publish WorkflowEvent:
   - DraftDocumentGenerationCompleted
   - Metadata: { FilePath: path, FileSize: bytes, DurationMs: X }

ERROR HANDLING:
- Template generation fails:
  * Retry 2 times with 5s, 10s backoff
  * If all fail, log error and STOP workflow
  * Send Teams alert: "âŒ Failed to generate draft for {JiraNumber}"
  * Publish WorkflowEvent: WorkflowFailed

- File I/O error (permissions, disk full):
  * Retry 3 times immediately
  * If fail, alert and stop

- AI call fails (if using Azure OpenAI):
  * Log warning
  * Use placeholder text: "AI-generated content unavailable"
  * Continue with template generation

VERIFICATION:
- File exists: C:\Temp\Documentation-Catalog\Drafts\BR-0001_DRAFT_irf_agent.docx
- DocumentChanges.DraftFilePath is populated
- WorkflowEvents shows generation events

ASK ARCHITECT IF:
- Don't have template classes or they're incomplete
- Unsure how to call templates
- Azure OpenAI integration unclear
- File path construction confusing

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
STEP 6: STORED PROCEDURE DOCUMENTATION CHECK
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

OBJECTIVE: Create new SP doc OR update existing SP doc (both as drafts)

WHAT YOU NEED:
IStoredProcedureDocumentationService (architect provided this)

WHAT IT MUST DO:
1. Check if change involves a stored procedure:
   - If DocumentChanges.StoredProcedureName IS NULL â†’ Skip this step
   - If DocumentChanges.StoredProcedureName IS NOT NULL â†’ Proceed

2. Check if SP documentation already exists:
   ```csharp
   var exists = await _spDocService.SPDocumentationExistsAsync(
       storedProcedureName,
       cancellationToken);
   ```

3A. IF SP DOC DOES NOT EXIST (New SP):
   - Generate new SP DocId: SP-0001 (using same MAX+1 logic)
   - Call StoredProcedureTemplate to create new doc
   - Save to /Drafts/: SP-0001_DRAFT_usp_ProcedureName.docx
   - Insert into DocumentChanges with:
     * DocId = SP-0001
     * Status = 'Completed'
     * JiraNumber = (same as parent change doc)
     * DocumentType = 'StoredProcedure'
     * ParentDocId = (parent change doc's DocId)
   - This SP doc will go through approval separately

3B. IF SP DOC EXISTS (Update existing):
   - Retrieve existing SP doc from final location
   - Determine current version (query DocumentVersionHistory)
   - Increment version: v1.0 â†’ v1.1
   - Create updated SP doc with:
     * Top section: "5 MOST RECENT CHANGES" (newest first)
     * Add current change to top of list
     * Keep only 5 most recent (move older to bottom "FULL VERSION HISTORY")
     * Update "WHAT'S NEW IN VERSION X.X" section with current change details
     * Adjust body content if change affects accuracy
   - Save to /Drafts/: SP-0001_DRAFT_usp_ProcedureName_v1.1.docx
   - Insert NEW DocumentChanges row for this updated SP doc:
     * DocId = SP-0001-v1.1 (or generate new SP-XXXX)
     * Status = 'Completed'
     * JiraNumber = (same)
     * ParentDocId = (parent change doc's DocId)
   - This updated SP doc goes through approval separately

4. Log SP doc creation/update in WorkflowEvents

CRITICAL NOTES:
- SP docs go through approval process SEPARATELY from change doc
- Both change doc AND SP doc must be approved individually
- If change doc is rejected, SP doc should also be rejected (future feature)
- If SP doc is rejected, change doc can still be approved (they're independent)

ERROR HANDLING:
- SP not found in database:
  * Already handled in Step 3
  * Skip SP doc creation
  
- Existing SP doc file not found:
  * Log error
  * Treat as new SP doc (create from scratch)

- Version increment logic fails:
  * Log error
  * Treat as v1.0 (create new version)

VERIFICATION:
- If new SP: Draft file exists in /Drafts/
- If update: Draft file with version number exists
- DocumentChanges has entry for SP doc
- Both change doc and SP doc are separate entries

ASK ARCHITECT IF:
- Don't have StoredProcedureDocumentationService
- Don't have StoredProcedureTemplate
- Versioning logic unclear
- Unsure how to update "5 MOST RECENT CHANGES" section

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
STEP 7: TEAMS NOTIFICATION WITH BATCHING
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

OBJECTIVE: Notify user that draft is ready for approval (with smart batching)

WHAT YOU NEED:
ITeamsNotificationService (architect provided this)

WHAT IT MUST DO:
1. Check batching rules (query TeamsNotificationLog):
   ```sql
   -- Count notifications sent in last 10 minutes
   SELECT COUNT(*)
   FROM DaQa.TeamsNotificationLog
   WHERE SentDate >= DATEADD(MINUTE, -10, GETUTCDATE())
   AND NotificationType = 'DraftApproval'
   ```

2. Apply batching logic:
   - If count < 5 â†’ Send individual notification
   - If count >= 5 â†’ Send batch notification (one message with list of pending docs)

3. Check 24hr cooldown per document:
   ```sql
   SELECT COUNT(*)
   FROM DaQa.TeamsNotificationLog
   WHERE DocumentId = @DocId
   AND SentDate >= DATEADD(HOUR, -24, GETUTCDATE())
   ```
   - If count > 0 â†’ Skip notification for this doc (already notified recently)

4. Send notification (if passed above checks):
   - Individual: Adaptive card with document details, approval button
   - Batch: Adaptive card with list of 5+ pending docs
   - Recipient: DocumentChanges.AssignedTo

5. Log notification:
   ```sql
   INSERT INTO DaQa.TeamsNotificationLog (
       DocumentId, NotificationType, RecipientEmail,
       SentDate, Success, ErrorMessage
   ) VALUES (
       @DocId, 'DraftApproval', @AssignedTo,
       GETUTCDATE(), @Success, @ErrorMessage
   )
   ```

6. Publish WorkflowEvent:
   - TeamsNotificationSent (or TeamsNotificationBatched)
   - Metadata: { RecipientCount: X, BatchMode: true/false }

ERROR HANDLING:
- Teams webhook fails:
  * Log error to TeamsNotificationLog (Success = false)
  * Continue workflow (notification failure is NOT blocking)
  * Do NOT retry Teams notification (cooldown prevents spam)

- Database log insert fails:
  * Log error
  * Continue (notification already sent)

CONFIGURATION:
Check appsettings.json:
```json
{
  "Teams": {
    "Enabled": false,  // Set to true when ready
    "WebhookUrl": "https://..."
  }
}
```

If Enabled = false, skip notification but still log to TeamsNotificationLog.

VERIFICATION:
- TeamsNotificationLog has entry
- WorkflowEvents shows notification event
- If Teams enabled: Check Teams channel for message

ASK ARCHITECT IF:
- Don't have ITeamsNotificationService
- Batching logic unclear
- Adaptive card format needed
- Webhook URL configuration unclear

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
STEP 8: ADD TO APPROVAL QUEUE
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

OBJECTIVE: Insert draft document into approval workflow

WHAT YOU NEED:
Method: AddToApprovalWorkflowAsync(string docId)

WHAT IT MUST DO:
1. Get document details from DocumentChanges:
   ```sql
   SELECT DocId, JiraNumber, DraftFilePath, AssignedTo, ReportedBy, DateRequested
   FROM DaQa.DocumentChanges
   WHERE DocId = @DocId
   ```

2. Insert into ApprovalWorkflow:
   ```sql
   INSERT INTO DaQa.ApprovalWorkflow (
       DocumentId, Status, RequestedBy, RequestedDate,
       ApproverEmail, DraftPath
   ) VALUES (
       @DocId, 'Pending', @ReportedBy, GETUTCDATE(),
       @AssignedTo, @DraftPath
   )
   ```

3. Publish WorkflowEvent:
   - DocumentAddedToApprovalQueue
   - Metadata: { DocId, ApprovalId }

4. IF this is an SP doc that was created/updated:
   - Insert separate ApprovalWorkflow entry for SP doc
   - Link to parent change doc (store ParentDocId in metadata)

ERROR HANDLING:
- Insert fails (duplicate?):
  * Log error
  * Check if already in queue (query ApprovalWorkflow)
  * If exists, update rather than insert

VERIFICATION:
Query: SELECT * FROM DaQa.ApprovalWorkflow WHERE Status = 'Pending'
Should see new entry (or two if SP doc also created).

ASK ARCHITECT IF:
- Don't have ApprovalWorkflow table schema
- Unsure about columns/fields
- Need help with insert logic

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
STEP 9: WORKFLOW PAUSE - AWAITING APPROVAL
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

OBJECTIVE: Draft workflow complete, waiting for user action

WHAT IT MEANS:
- Draft document is in /Drafts/ folder
- Entry in ApprovalWorkflow with Status='Pending'
- Teams notification sent (if enabled)
- User can view in approval page (frontend)
- No further automatic processing until user approves/rejects

VERIFICATION:
Check all these are true:
1. âœ“ DraftFilePath exists on disk
2. âœ“ DocumentChanges.DraftFilePath populated
3. âœ“ ApprovalWorkflow entry with Status='Pending'
4. âœ“ WorkflowEvents show complete draft workflow
5. âœ“ TeamsNotificationLog has entry
6. âœ“ MasterIndex is NOT yet populated (happens after approval)

USER ACTIONS AVAILABLE:
- Approve â†’ Triggers Step 10 (post-approval workflow)
- Reject â†’ Triggers AI refinement (Step 9A)

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
STEP 9A: REJECTION WITH AI REFINEMENT (v1.5 FEATURE - BUILD NOW)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

OBJECTIVE: Allow user to reject with feedback, AI refines draft

WHAT YOU NEED:
Method in ApprovalTrackingService: RejectDocumentAsync(approvalId, rejectionReason)

WHAT IT MUST DO:
1. Get approval details:
   ```sql
   SELECT DocumentId, DraftPath, RejectionCount
   FROM DaQa.ApprovalWorkflow
   WHERE ApprovalId = @ApprovalId
   ```

2. Check rejection count:
   - If RejectionCount >= 3 â†’ Stop, require manual intervention
   - Alert: "Document rejected 3 times, manual review required"

3. Publish WorkflowEvent:
   - DocumentRejected
   - Metadata: { Reason, RejectionCount }

4. Call AI refinement:
   - Read original draft document
   - Extract current content
   - Create prompt:
     ```
     You previously generated this documentation:
     [current draft content]
     
     The reviewer rejected it with this feedback:
     "{rejectionReason}"
     
     Please refine the documentation to address this feedback.
     Maintain the same structure and format, but improve the content.
     ```
   - Generate refined content using Azure OpenAI

5. Increment version (internal tracking):
   - v1.0-draft â†’ v1.1-draft (not in filename, just metadata)

6. Update draft document:
   - Overwrite existing draft file with refined version
   - Keep same filename (still in /Drafts/)

7. Update ApprovalWorkflow:
   ```sql
   UPDATE DaQa.ApprovalWorkflow
   SET Status = 'Pending',  -- Back to pending
       RejectionCount = RejectionCount + 1,
       LastRejectionReason = @RejectionReason,
       LastRejectionDate = GETUTCDATE()
   WHERE ApprovalId = @ApprovalId
   ```

8. Send NEW Teams notification:
   - "ğŸ“ Revised draft ready for review"
   - Include rejection reason and revision number

9. Publish WorkflowEvent:
   - DraftRefined
   - Metadata: { RevisionNumber, RejectionReason }

ERROR HANDLING:
- AI refinement fails:
  * Retry 2 times
  * If still fails, mark as "Requires Manual Review"
  * Send Teams alert
  * Do NOT increment RejectionCount (not user's fault)

- File overwrite fails:
  * Retry 3 times
  * If fails, create new draft file with _Rev{N} suffix
  * Update DraftFilePath in DocumentChanges

VERIFICATION:
- Draft file updated with refined content
- ApprovalWorkflow.RejectionCount incremented
- WorkflowEvents shows rejection and refinement
- User receives new Teams notification

ASK ARCHITECT IF:
- Unsure how to read existing Word document content
- AI refinement prompt template needed
- Unclear on version tracking
- Error handling logic confusing

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
STEP 10: POST-APPROVAL - DOCUMENT APPROVAL
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

OBJECTIVE: User clicks "Approve" - trigger post-approval workflow

WHAT YOU NEED:
ApprovalTrackingService.ApproveDocumentAsync(approvalId, approvedBy)
(Architect provided complete implementation)

WHAT IT MUST DO:
1. Validate approval:
   ```sql
   SELECT * FROM DaQa.ApprovalWorkflow
   WHERE ApprovalId = @ApprovalId AND Status = 'Pending'
   ```
   - If not found or Status != 'Pending' â†’ Error

2. Generate WorkflowId:
   - WorkflowId = "WF-{DocumentId}" (e.g., "WF-BR-0001")

3. Publish DocumentApproved event

4. Update ApprovalWorkflow:
   ```sql
   UPDATE DaQa.ApprovalWorkflow
   SET Status = 'Approved',
       ApprovedBy = @ApprovedBy,
       ApprovedDate = GETUTCDATE(),
       Comments = @Comments
   WHERE ApprovalId = @ApprovalId
   ```

THEN PROCEED TO STEP 11 (Final Document Generation)

ASK ARCHITECT IF:
- Don't have ApprovalTrackingService
- Need complete ApproveDocumentAsync implementation
- Unclear on approval validation

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
STEP 11: POST-APPROVAL - FINAL DOCUMENT GENERATION
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

OBJECTIVE: Remove DRAFT, move to final location with proper naming

WHAT IT MUST DO:
1. Publish WorkflowEvent:
   - FinalDocumentGenerationStarted

2. Get draft path from DocumentChanges:
   ```sql
   SELECT DraftFilePath, DocId, TableName, ColumnName, JiraNumber
   FROM DaQa.DocumentChanges
   WHERE DocId = @DocId
   ```

3. Build final path using database-mirrored structure:
   - Base: C:\Temp\Documentation-Catalog
   - For change docs:
     * Path: /Database/IRFS1/{SchemaName}/Tables/{TableName}/Change Documentation/
     * Filename: {DocId}-{TableName}-{ColumnName}-{JiraNumber}.docx
     * Example: BR-0043-irf_agent-All-BAS-9751.docx
   
   - For SP docs:
     * Path: /Database/IRFS1/{SchemaName}/StoredProcedures/
     * Filename: SP-0001-usp_ProcedureName.docx

4. Create directory structure if doesn't exist:
   ```csharp
   Directory.CreateDirectory(Path.GetDirectoryName(finalPath));
   ```

5. Copy draft to final location:
   ```csharp
   File.Copy(draftPath, finalPath, overwrite: true);
   ```

6. Update DocumentChanges:
   ```sql
   UPDATE DaQa.DocumentChanges
   SET FinalFilePath = @FinalPath,
       Status = 'Approved'
   WHERE DocId = @DocId
   ```

7. Publish WorkflowEvent:
   - FinalDocumentGenerationCompleted
   - Metadata: { FinalPath, FileSize, DurationMs }

ERROR HANDLING:
- Directory creation fails:
  * Retry 3 times
  * If fails, alert and stop
  
- File copy fails:
  * Retry 3 times
  * Check disk space
  * Check permissions
  * If fails, alert and stop

VERIFICATION:
- Final file exists at expected path
- DocumentChanges.FinalFilePath populated
- Draft file still exists in /Drafts/ (keep for audit trail)

ASK ARCHITECT IF:
- Path construction unclear
- Unsure how to determine SchemaName from DocumentChanges
- Directory creation logic confusing

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
STEP 12: POST-APPROVAL - MASTERINDEX POPULATION (116 FIELDS)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

OBJECTIVE: Extract comprehensive metadata, populate MasterIndex

WHAT YOU NEED:
IComprehensiveMasterIndexService (architect provided complete implementation)

WHAT IT MUST DO:
1. Publish WorkflowEvent:
   - MasterIndexPopulationStarted
   - Message: "Populating MasterIndex with comprehensive metadata (116 fields, 14 phases)"

2. Call MasterIndex service:
   ```csharp
   var indexId = await _masterIndexService.PopulateMasterIndexFromApprovedDocumentAsync(
       documentId,      // BR-0001
       finalFilePath,   // Full path to final doc
       jiraNumber,      // BAS-9751
       cancellationToken);
   ```

3. Service executes 14 phases automatically:
   - Phase 1: Source system data (7 fields)
   - Phase 2: Document analysis (10 fields) - extracts from Word doc
   - Phase 3: Database metadata (8 fields) - queries INFORMATION_SCHEMA
   - Phase 4: Business context (3 fields) - extracts from doc text
   - Phase 5: Technical details (3 fields) - code snippets, SPs
   - Phase 6: Ownership (4 fields) - CreatedBy, ModifiedBy
   - Phase 7: Classification (3 fields) - PII detection, sensitivity
   - Phase 8: Relationships (2 fields) - related docs, Jira links
   - Phase 9: Quality metrics (2 fields) - calculated scores
   - Phase 10: Usage tracking (3 fields) - initialized to 0
   - Phase 11: Lifecycle (5 fields) - Approved, Active
   - Phase 12: Compliance (2 fields) - retention, tags
   - Phase 13: Performance stats (3 fields) - completeness %
   - Phase 14: Audit trail (3 fields) - version, change reason

4. Service returns IndexId (GUID or string)

5. Get completeness stats:
   ```csharp
   var stats = await GetMasterIndexStatsAsync(indexId);
   // Returns: PopulatedFields, CompletenessPercentage, QualityScore
   ```

6. Publish WorkflowEvent:
   - MasterIndexPopulationCompleted
   - Message: "MasterIndex populated: {stats.PopulatedFields}/116 fields ({stats.CompletenessPercentage}%)"
   - Metadata: { IndexId, PopulatedFields: 89, TotalFields: 116, CompletenessPercentage: 77 }

ERROR HANDLING:
- MasterIndex service throws exception:
  * Log full error details
  * Publish WorkflowEvent: MasterIndexPopulationFailed
  * Send Teams alert
  * DO NOT continue workflow (MasterIndex is critical)

VERIFICATION:
Query: SELECT * FROM DaQa.MasterIndex WHERE IndexID = @IndexId
Should see row with ~77-85% of fields populated (89/116 fields).

CRITICAL NOTES:
- This service already exists - DO NOT rewrite it
- It uses OpenXML to read Word docs
- It queries DocumentChanges and INFORMATION_SCHEMA
- It calculates quality scores automatically
- Completeness percentage should be 77-85% (89/116 fields)

ASK ARCHITECT IF:
- Can't find IComprehensiveMasterIndexService
- Getting errors from MasterIndex service
- Completeness percentage is < 70% (something wrong)
- Don't know how to get stats after population

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
STEP 13: POST-APPROVAL - EMBED CUSTOMPROPERTIES IN DOCUMENT
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

OBJECTIVE: Embed hidden metadata in Word document for tracking

WHAT YOU NEED:
CustomPropertiesHelper (architect provided complete implementation)

WHAT IT MUST DO:
1. Call helper to embed metadata:
   ```csharp
   CustomPropertiesExtensions.EmbedApprovalMetadata(
       finalFilePath,
       documentId,      // BR-0001
       jiraNumber,      // BAS-9751
       indexId,         // From Step 12
       new ApprovalMetadataDto
       {
           SchemaName = approval.SchemaName,
           TableName = approval.TableName,
           ColumnName = approval.ColumnName,
           CodeQualityScore = approval.CodeQualityScore,
           CodeQualityGrade = approval.CodeQualityGrade,
           ReportedBy = approval.ReportedBy,
           AssignedTo = approval.AssignedTo,
           ApprovedBy = approvedBy,
           DateRequested = approval.DateRequested
       });
   ```

2. This embeds 17 hidden properties in Word document:
   - DocId, JiraNumber, MasterIndexId, DocumentType, Version
   - SchemaName, TableName, ColumnName
   - CodeQualityScore, CodeQualityGrade
   - ReportedBy, AssignedTo, ApprovedBy
   - DateRequested, DateApproved
   - ApprovalStatus, WorkflowStatus

3. Properties are INVISIBLE to users (no visible change to document)

4. Properties can be read later for:
   - Compliance audits
   - Metadata validation
   - Document tracking
   - Natural language search (future)

ERROR HANDLING:
- CustomProperties embedding fails:
  * Log warning (not critical)
  * Continue workflow
  * Document is still valid without properties

VERIFICATION:
- Open document in Word
- File â†’ Info â†’ Properties â†’ Advanced Properties â†’ Custom tab
- Should see all 17 properties listed

ASK ARCHITECT IF:
- Don't have CustomPropertiesHelper
- Getting OpenXML errors
- Unsure how to verify properties embedded

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
STEP 14: POST-APPROVAL - SP DOCUMENTATION VERSIONING (IF APPLICABLE)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

OBJECTIVE: Create/update SP documentation after approval

WHAT YOU NEED:
IStoredProcedureDocumentationService (architect provided)

WHAT IT MUST DO:
1. Check if change involves SP:
   - If StoredProcedureName IS NULL â†’ Skip
   - If StoredProcedureName NOT NULL â†’ Proceed

2. Call SP documentation service:
   ```csharp
   var spDocId = await _spDocService.CreateOrUpdateSPDocumentationAsync(
       storedProcedureName,
       documentId,      // Parent change doc (BR-0001)
       cancellationToken);
   ```

3. Service automatically:
   - Checks if SP doc exists
   - If new: Creates SP-XXXX doc
   - If exists: Increments version (v1.0 â†’ v1.1)
   - Updates "5 MOST RECENT CHANGES" section
   - Moves old changes to "FULL VERSION HISTORY"
   - Adds entry to DocumentVersionHistory table

4. SP doc goes through its own approval (handled separately in Steps 10-13)

ERROR HANDLING:
- SP doc creation fails:
  * Log warning
  * Continue (SP doc is supplementary)
  * Send Teams notification about failure

VERIFICATION:
- If SP doc created: Check DocumentChanges for SP-XXXX entry
- If SP doc updated: Check DocumentVersionHistory for new version
- SP doc draft should be in approval queue

ASK ARCHITECT IF:
- Don't have IStoredProcedureDocumentationService
- Versioning logic unclear
- Don't understand "5 MOST RECENT CHANGES" update

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
STEP 15: POST-APPROVAL - FINAL WORKFLOW EVENTS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

OBJECTIVE: Log completion and close workflow

WHAT IT MUST DO:
1. Publish FileSavedToSharePoint event:
   - Message: "Final document saved: {filename}"
   - Metadata: { FilePath, FileSize, MasterIndexId }

2. Publish WorkflowCompleted event:
   - Message: "End-to-end workflow completed for {documentId}"
   - Metadata: { DocumentId, FinalPath, MasterIndexId, MetadataCompleteness: 77%, ApprovedBy }

3. Log final success message

ERROR HANDLING:
- Event publishing fails:
  * Log error
  * Continue (events are audit trail, not blocking)

VERIFICATION:
Query WorkflowEvents:
```sql
SELECT *
FROM DaQa.WorkflowEvents
WHERE WorkflowId = 'WF-BR-0001'
ORDER BY Timestamp
```

Should see complete event sequence:
1. WatcherDetectedNewRow
2. CodeExtractionStarted/Completed
3. CodeQualityAuditStarted/Completed
4. DraftDocumentGenerationStarted/Completed
5. TeamsNotificationSent
6. DocumentAddedToApprovalQueue
7. [Pause for user approval]
8. DocumentApproved
9. FinalDocumentGenerationStarted/Completed
10. MasterIndexPopulationStarted/Completed
11. FileSavedToSharePoint
12. WorkflowCompleted

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
TESTING CHECKLIST - RUN AFTER ALL STEPS IMPLEMENTED
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

END-TO-END TEST:

1. â–¡ Prepare test data in Excel:
   - Set Status = "Completed" for one row
   - Ensure DocId is NULL
   - Fill in JiraNumber, TableName, ColumnName, AssignedTo

2. â–¡ Start ExcelChangeIntegratorService:
   - Verify sync to DocumentChanges

3. â–¡ Start DocGeneratorService:
   - Watch for DocId generation
   - Watch for draft creation in /Drafts/
   - Check WorkflowEvents table for event sequence

4. â–¡ Check approval queue:
   - Query ApprovalWorkflow for Pending status
   - Verify Teams notification (if enabled)

5. â–¡ Approve document via API/UI:
   - Call ApproveDocumentAsync
   - Watch for final document creation
   - Verify MasterIndex population
   - Check CustomProperties embedded

6. â–¡ Verify final state:
   - â–¡ Final document in correct path with correct name
   - â–¡ MasterIndex has entry with 77%+ completeness
   - â–¡ DocumentChanges.Status = 'Approved'
   - â–¡ ApprovalWorkflow.Status = 'Approved'
   - â–¡ WorkflowEvents shows complete sequence
   - â–¡ CustomProperties visible in Word document

7. â–¡ Test error scenarios:
   - SP not found in database (should warn, continue)
   - AI generation failure (should retry, then alert)
   - File I/O error (should retry, then alert)

8. â–¡ Test rejection with refinement:
   - Reject document with reason
   - Verify AI generates refined draft
   - Verify RejectionCount incremented
   - Verify new Teams notification sent

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
SERVICE REGISTRATION CHECKLIST
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

Verify these services are registered in Program.cs:

â–¡ builder.Services.AddHttpClient();
â–¡ builder.Services.AddSignalR();
â–¡ builder.Services.AddScoped<IWorkflowEventService, WorkflowEventService>();
â–¡ builder.Services.AddScoped<IEnterpriseCodeQualityAuditService, EnterpriseCodeQualityAuditService>();
â–¡ builder.Services.AddScoped<ITeamsNotificationService, TeamsNotificationService>();
â–¡ builder.Services.AddScoped<IComprehensiveMasterIndexService, ComprehensiveMasterIndexService>();
â–¡ builder.Services.AddScoped<IStoredProcedureDocumentationService, StoredProcedureDocumentationService>();
â–¡ builder.Services.AddScoped<IApprovalTrackingService, ApprovalTrackingService>();

Verify CORS (if using SignalR - skip for now):
â–¡ builder.Services.AddCors(options => { ... });

Verify configuration sections in appsettings.json:
â–¡ ConnectionStrings:DefaultConnection
â–¡ DocGenerator:MockSharePointPath
â–¡ Teams:Enabled, Teams:WebhookUrl
â–¡ AzureOpenAI (if using AI)

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
IMPLEMENTATION PROTOCOL
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

FOR EACH STEP:

1. READ the step completely
2. CHECK what you currently have
3. IDENTIFY what's missing or needs fixing
4. ASK architect Claude for:
   - Complete service implementation if missing
   - Specific method code if unclear
   - Configuration guidance if needed
5. IMPLEMENT the code
6. TEST the step individually
7. VERIFY using the verification section
8. MOVE to next step ONLY when current step works

DO NOT:
- Skip steps
- Assume code works without testing
- Move forward if current step fails
- Modify existing working services (like EnterpriseCodeQualityAuditService)
- Create placeholder code "to implement later"

DO:
- Test each step with real data
- Log everything to WorkflowEvents
- Handle errors gracefully
- Ask for code when unsure
- Verify database state after each step

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
WHEN TO ASK ARCHITECT CLAUDE
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

Ask when you need:
1. Complete service implementation (e.g., "Give me complete DocGeneratorService")
2. Specific method code (e.g., "Give me ExtractMarkedCodeAsync method")
3. Template implementation (e.g., "Give me BusinessRequestTemplate.Generate method")
4. Database query help (e.g., "How to query for max DocId?")
5. File path construction logic
6. Error handling patterns
7. Configuration examples
8. Testing data/scenarios

Don't ask for:
- General programming questions (you know C#)
- Trivial syntax issues
- Basic LINQ queries
- Standard error handling (try-catch)

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
SUCCESS CRITERIA
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

You will know the system is working when:

âœ“ Excel change â†’ DocumentChanges sync works
âœ“ DocId auto-generated correctly
âœ“ Draft document created in /Drafts/
âœ“ SP documentation created/updated if applicable
âœ“ Teams notification sent (if enabled)
âœ“ Approval queue populated
âœ“ User can approve document
âœ“ Final document moved to correct database-mirrored path
âœ“ MasterIndex populated with 77%+ fields
âœ“ CustomProperties embedded in document
âœ“ WorkflowEvents shows complete sequence
âœ“ All error scenarios handled gracefully

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
FINAL NOTES
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

This is the FOUNDATION agent. Everything else builds on this.

Quality > Speed. Get it right.

Test thoroughly. Use real data.

Ask architect Claude when stuck.

Log everything. WorkflowEvents are your audit trail.

Handle errors properly. Production systems fail gracefully.

You've got this. Let's build something awesome tonight.

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
